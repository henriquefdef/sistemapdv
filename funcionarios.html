<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume - Funcionários</title>
    <link rel="icon" type="image/png" href="log.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="header.css" rel="stylesheet">
    
    <style>
        :root {
            --cor-laranja: #FF9800;
            --cor-laranja-hover: #FB8C00;
            --cor-fundo-pagina: #f4f7f6;
            --cor-fundo-card: #ffffff;
            --cor-texto-principal: #2c3e50;
            --cor-texto-secundario: #7f8c8d;
            --cor-borda: #e0e6ed;
            --sombra-card: 0 10px 40px -10px rgba(0, 64, 128, 0.1);
        }

        body {
            background-color: var(--cor-fundo-pagina);
            color: var(--cor-texto-principal);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding-left: 80px;
            transition: padding-left 0.3s ease;
        }

        .main-container {
            padding: 30px 40px;
            max-width: 1300px;
            margin: 0 auto;
        }

        .form-card {
            background-color: var(--cor-fundo-card);
            border-radius: 16px;
            box-shadow: var(--sombra-card);
            overflow: hidden;
        }

        .form-card-body {
            padding: 40px;
        }
        
        /* Navegação das abas */
        .tab-nav {
            display: flex;
            gap: 2rem;
            margin-bottom: 2.5rem;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 0;
        }

        .tab-nav-item {
            padding: 0.75rem 0;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--cor-texto-secundario);
            font-size: 0.95rem;
            font-weight: 500;
            position: relative;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }

        .tab-nav-item:hover {
            color: var(--cor-texto-principal);
        }

        .tab-nav-item.active {
            color: var(--cor-laranja);
            font-weight: 600;
            border-bottom-color: var(--cor-laranja);
        }

        /* Conteúdo das abas */
        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }
        
        /* Divisória elegante entre as seções */
        .section-divider {
            border: 0;
            height: 1px;
            background-color: var(--cor-borda);
            margin: 40px 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .section-header i {
            font-size: 1.2rem;
            color: var(--cor-laranja);
        }

        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
        }

        .form-group label { 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: #555; 
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 1px solid var(--cor-borda);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cor-laranja);
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
        }

        .form-group input:read-only {
            background-color: #f0f2f5;
            cursor: not-allowed;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        /* Rodapé com botão */
        .form-footer {
            margin-top: 40px;
            padding: 20px 40px;
            background-color: #f8f9fa;
            border-top: 1px solid var(--cor-borda);
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        
        #message { 
            font-weight: 600; 
            margin-right: auto; 
        }
        
        .btn-salvar {
            background: linear-gradient(135deg, var(--cor-laranja), var(--cor-laranja-hover));
            color: white; 
            border: none; 
            padding: 12px 30px; 
            border-radius: 8px;
            font-weight: bold; 
            font-size: 1rem; 
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-salvar:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px -5px rgba(255, 152, 0, 0.5); 
        }

        .btn-salvar:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }

        /* Lista de funcionários */
        .funcionarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .funcionario-card {
            background: white;
            border: 1px solid var(--cor-borda);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .funcionario-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .funcionario-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .funcionario-info h3 {
            margin: 0 0 5px 0;
            color: var(--cor-texto-principal);
        }

        .funcionario-codigo {
            background: #f8f9fa;
            color: var(--cor-texto-secundario);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .funcionario-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .funcionario-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .funcionario-detail {
            display: flex;
            flex-direction: column;
        }

        .funcionario-detail strong {
            color: var(--cor-texto-secundario);
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--cor-texto-secundario);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--cor-borda);
            margin-bottom: 20px;
            display: block;
        }

        /* Limite de funcionários */
        .limit-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .limit-warning i {
            font-size: 1.2rem;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-grid-3 {
                grid-template-columns: 1fr;
            }

            .funcionarios-grid {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                gap: 1rem;
            }

            .funcionario-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="header-container"></div>

    <main class="main-container">
        <div class="form-card">
            <div class="form-card-body">
                
                <!-- Navegação das abas -->
                <div class="tab-nav">
                    <button class="tab-nav-item active" data-tab="criar">Criar Funcionário</button>
                    <button class="tab-nav-item" data-tab="lista">Funcionários Ativos</button>
                </div>

                <!-- Aba: Criar Funcionário -->
                <div id="criar" class="tab-pane active">
                    
                    <div id="limit-warning" class="limit-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Você tem bastante funcionário, fale com desenvolvedor para criar mais!</span>
                    </div>

                    <form id="funcionario-form">
                        <section>
                            <div class="section-header">
                                <i class="fas fa-user-plus"></i>
                                <h2>Informações Pessoais</h2>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nome" class="required">Nome Completo</label>
                                    <input type="text" id="nome" placeholder="Digite o nome completo" required>
                                </div>
                                <div class="form-group">
                                    <label for="codigo">Código do Funcionário</label>
                                    <input type="text" id="codigo" placeholder="Gerado automaticamente" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="email" class="required">E-mail</label>
                                    <input type="email" id="email" placeholder="email@exemplo.com" required>
                                </div>
                                <div class="form-group">
                                    <label for="telefone" class="required">Telefone</label>
                                    <input type="tel" id="telefone" placeholder="(00) 90000-0000" required>
                                </div>
                                <div class="form-group">
                                    <label for="genero">Gênero</label>
                                    <select id="genero">
                                        <option value="">Selecione</option>
                                        <option value="masculino">Masculino</option>
                                        <option value="feminino">Feminino</option>
                                        <option value="outro">Outro</option>
                                        <option value="nao_informar">Prefiro não informar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="data_nascimento">Data de Nascimento</label>
                                    <input type="date" id="data_nascimento">
                                </div>
                            </div>
                        </section>

                        <hr class="section-divider">

                        <section>
                            <div class="section-header">
                                <i class="fas fa-briefcase"></i>
                                <h2>Informações Profissionais</h2>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="data_admissao" class="required">Data de Admissão</label>
                                    <input type="date" id="data_admissao" required>
                                </div>
                                <div class="form-group">
                                    <label for="meta_vendas">Meta de Vendas Mensal (R$)</label>
                                    <input type="number" id="meta_vendas" placeholder="0,00" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="senha_funcionario" class="required">Senha de Acesso</label>
                                    <input type="password" id="senha_funcionario" placeholder="Senha para o funcionário acessar o sistema" required autocomplete="new-password">
                                    <small style="color: var(--cor-texto-secundario); font-size: 0.8rem; margin-top: 4px; display: block;">
                                        Esta senha será usada pelo funcionário para acessar o sistema na primeira vez. Mín. 8 caracteres.
                                    </small>
                                </div>
                            </div>
                        </section>

                        <hr class="section-divider">

                        <section>
                            <div class="section-header">
                                <i class="fas fa-map-marker-alt"></i>
                                <h2>Endereço</h2>
                            </div>
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                                <div class="form-group" style="grid-column: 1 / 2;">
                                    <label for="cep">CEP</label>
                                    <input type="text" id="cep" placeholder="00000-000">
                                </div>
                                <div class="form-group" style="grid-column: 2 / 5;">
                                    <label for="rua">Rua</label>
                                    <input type="text" id="rua" placeholder="Preenchido automaticamente" readonly>
                                </div>
                                <div class="form-group" style="grid-column: 5 / 6;">
                                    <label for="numero">Número</label>
                                    <input type="text" id="numero" placeholder="Ex: 123">
                                </div>
                                <div class="form-group" style="grid-column: 1 / 3;">
                                    <label for="complemento">Complemento</label>
                                    <input type="text" id="complemento" placeholder="Apto, Bloco, etc.">
                                </div>
                                <div class="form-group" style="grid-column: 3 / 5;">
                                    <label for="bairro">Bairro</label>
                                    <input type="text" id="bairro" placeholder="Preenchido automaticamente" readonly>
                                </div>
                                <div class="form-group" style="grid-column: 5 / 6;">
                                    <label for="cidade">Cidade</label>
                                    <input type="text" id="cidade" placeholder="Preenchido automaticamente" readonly>
                                </div>
                            </div>
                        </section>
                    </form>
                </div>

                <!-- Aba: Lista de Funcionários -->
                <div id="lista" class="tab-pane">
                    <div class="section-header">
                        <i class="fas fa-users"></i>
                        <h2>Funcionários Ativos</h2>
                        <span id="contador-funcionarios" style="margin-left: auto; color: var(--cor-texto-secundario); font-size: 0.9rem;"></span>
                    </div>
                    
                    <div id="funcionarios-container">
                        <!-- Funcionários serão carregados aqui -->
                    </div>
                </div>
            </div>
            
            <div class="form-footer">
                <div id="message"></div>
                <button type="submit" form="funcionario-form" class="btn-salvar">
                    <i class="fas fa-save"></i> Cadastrar Funcionário
                </button>
            </div>
        </div>
    </main>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="header.js"></script>

    <script>
        document.addEventListener('userDataReady', () => {
            if (!window.currentCompanyId) {
                console.error("ID da empresa não encontrado.");
                return;
            }
            
            // DESABILITAR AUTOCOMPLETE E CACHE PARA TODA A PÁGINA
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.setAttribute('autocomplete', 'off');
                element.setAttribute('data-form-type', 'other');
            });
            
            // Configuração do Supabase
            const supabaseClient = supabase.createClient(
                'https://gnehkswoqlpchtlgyjyj.supabase.co', 
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZWhrc3dvcWxwY2h0bGd5anlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4OTY3NjYsImV4cCI6MjA2OTQ3Mjc2Nn0.8giA1bDvCzgvlcW_pkimGO9qHRF2I0QfhG6nx9U_tdY'
            );

            // Elementos da página
            const form = document.getElementById('funcionario-form');
            const messageDiv = document.getElementById('message');
            const cepInput = document.getElementById('cep');
            const limitWarning = document.getElementById('limit-warning');
            const saveButton = document.querySelector('.btn-salvar');
            const contadorFuncionarios = document.getElementById('contador-funcionarios');
            
            let funcionarios = [];
            let editingFuncionarioId = null;

            // Configuração das abas
            setupTabs();

            // Configuração do formulário
            setupForm();

            // Carrega os dados iniciais
            loadFuncionarios();

            // === FUNÇÕES PRINCIPAIS ===

            function setupTabs() {
                const tabButtons = document.querySelectorAll('.tab-nav-item');
                const tabPanes = document.querySelectorAll('.tab-pane');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // Remove active de todos
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabPanes.forEach(pane => pane.classList.remove('active'));
                        
                        // Ativa o clicado
                        button.classList.add('active');
                        const tabId = button.dataset.tab;
                        document.getElementById(tabId).classList.add('active');

                        // Se mudou para lista, recarrega os funcionários
                        if (tabId === 'lista') {
                            loadFuncionarios();
                        }
                    });
                });
            }

            function setupForm() {
                // Gerar código automático
                generateEmployeeCode();

                // CEP automático
                cepInput.addEventListener('blur', handleCEPLookup);

                // Validações em tempo real
                document.getElementById('email').addEventListener('blur', validateEmail);
                document.getElementById('nome').addEventListener('input', validateName);

                // Submit do formulário
                form.addEventListener('submit', handleFormSubmit);

                // Data de admissão padrão (hoje)
                document.getElementById('data_admissao').value = new Date().toISOString().split('T')[0];
            }

            function generateEmployeeCode() {
                const timestamp = Date.now().toString();
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const code = `FUNC${timestamp.slice(-4)}${random}`;
                document.getElementById('codigo').value = code;
            }

            async function handleCEPLookup(event) {
                const cep = event.target.value.replace(/\D/g, '');
                if (cep.length !== 8) return;

                try {
                    showMessage('Buscando CEP...', false);
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    
                    if (data.erro) {
                        throw new Error('CEP não encontrado.');
                    }
                    
                    document.getElementById('rua').value = data.logradouro;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('cidade').value = data.localidade;
                    showMessage('', false);
                } catch (error) {
                    console.error('Erro ao buscar CEP:', error);
                    showMessage(error.message, true);
                }
            }

            function validateEmail(event) {
                const email = event.target.value;
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (email && !emailRegex.test(email)) {
                    showMessage('E-mail inválido', true);
                    return false;
                }
                
                showMessage('', false);
                return true;
            }

            function validateName(event) {
                const name = event.target.value.trim();
                
                if (name && name.length < 2) {
                    showMessage('Nome deve ter pelo menos 2 caracteres', true);
                    return false;
                }
                
                showMessage('', false);
                return true;
            }

            async function handleFormSubmit(event) {
                event.preventDefault();
                
                // Verifica limite de funcionários com mensagem personalizada
                if (!editingFuncionarioId && funcionarios.length >= 10) {
                    showMessage('Você tem bastante funcionário, falei com desenvolvedor para criar mais!', true);
                    return;
                }

                // Validações
                if (!validateForm()) {
                    return;
                }

                // Loading state
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                try {
                    const funcionarioData = collectFormData();

                    if (editingFuncionarioId) {
                        await updateFuncionario(editingFuncionarioId, funcionarioData);
                        showMessage('Funcionário atualizado com sucesso!', false);
                    } else {
                        await createFuncionario(funcionarioData);
                        showMessage('Funcionário cadastrado, passe a senha para ele e o sempre de trocá-la.', false);
                        resetForm();
                    }

                    await loadFuncionarios();

                } catch (error) {
                    console.error('Erro ao salvar funcionário:', error);
                    showMessage(error.message, true);
                } finally {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Cadastrar Funcionário';
                }
            }

            function validateForm() {
                const nome = document.getElementById('nome').value.trim();
                const email = document.getElementById('email').value.trim();
                const telefone = document.getElementById('telefone').value.trim();
                const dataAdmissao = document.getElementById('data_admissao').value;
                const senhaFuncionario = document.getElementById('senha_funcionario').value;

                if (!nome || nome.length < 2) {
                    showMessage('Nome é obrigatório e deve ter pelo menos 2 caracteres', true);
                    return false;
                }

                if (!email || !validateEmail({ target: { value: email } })) {
                    showMessage('E-mail válido é obrigatório', true);
                    return false;
                }

                if (!telefone) {
                    showMessage('Telefone é obrigatório', true);
                    return false;
                }

                if (!dataAdmissao) {
                    showMessage('Data de admissão é obrigatória', true);
                    return false;
                }

                if (!editingFuncionarioId && (!senhaFuncionario || senhaFuncionario.length < 6)) {
                    showMessage('Senha é obrigatória e deve ter pelo menos 6 caracteres', true);
                    return false;
                }

                return true;
            }

            function collectFormData() {
                return {
                    nome: document.getElementById('nome').value.trim(),
                    codigo: document.getElementById('codigo').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    telefone: document.getElementById('telefone').value.trim(),
                    genero: document.getElementById('genero').value || null,
                    data_nascimento: document.getElementById('data_nascimento').value || null,
                    data_admissao: document.getElementById('data_admissao').value,
                    meta_vendas: parseFloat(document.getElementById('meta_vendas').value) || 0,
                    cep: document.getElementById('cep').value.replace(/\D/g, '') || null,
                    rua: document.getElementById('rua').value.trim() || null,
                    numero: document.getElementById('numero').value.trim() || null,
                    complemento: document.getElementById('complemento').value.trim() || null,
                    bairro: document.getElementById('bairro').value.trim() || null,
                    cidade: document.getElementById('cidade').value.trim() || null,
                    senha_funcionario: document.getElementById('senha_funcionario').value || null,
                    ativo: true,
                    id_empresa: window.currentCompanyId,
                    auth_user_id: window.currentUser.auth_user_id
                };
            }

            async function createFuncionario(funcionarioData) {
                // Verifica se email já existe na tabela funcionarios
                const { data: existingEmployee } = await supabaseClient
                    .from('funcionarios')
                    .select('id')
                    .eq('id_empresa', window.currentCompanyId)
                    .eq('email', funcionarioData.email)
                    .eq('ativo', true);

                if (existingEmployee && existingEmployee.length > 0) {
                    throw new Error('Já existe um funcionário ativo com este e-mail');
                }

                // Verifica se email já existe na tabela user
                const { data: existingUser } = await supabaseClient
                    .from('user')
                    .select('id')
                    .eq('email', funcionarioData.email);

                if (existingUser && existingUser.length > 0) {
                    throw new Error('Este e-mail já está cadastrado no sistema');
                }

                // Verifica se código já existe
                const { data: existingCode } = await supabaseClient
                    .from('funcionarios')
                    .select('id')
                    .eq('id_empresa', window.currentCompanyId)
                    .eq('codigo', funcionarioData.codigo);

                if (existingCode && existingCode.length > 0) {
                    // Gera novo código
                    generateEmployeeCode();
                    funcionarioData.codigo = document.getElementById('codigo').value;
                }

                try {
                    // 1. CRIAR CONTA NO SUPABASE AUTH
                    const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                        email: funcionarioData.email,
                        password: funcionarioData.senha_funcionario,
                        options: {
                            emailRedirectTo: `${window.location.origin}/login.html`,
                            data: {
                                full_name: funcionarioData.nome,
                                phone: funcionarioData.telefone,
                                funcao: 'funcionario'
                            }
                        }
                    });

                    if (authError) {
                        console.error('Erro ao criar conta auth:', authError);
                        throw new Error('Erro ao criar conta de acesso: ' + authError.message);
                    }

                    if (!authData.user) {
                        throw new Error('Falha ao criar usuário no sistema de autenticação');
                    }

                    const authUserId = authData.user.id;

                    try {
                        // 2. CRIAR REGISTRO NA TABELA USER
                        const { error: userError } = await supabaseClient
                            .from('user')
                            .insert([{
                                nome: funcionarioData.nome,
                                telefone: funcionarioData.telefone,
                                email: funcionarioData.email,
                                funcao: 'funcionario',
                                id_empresa: window.currentCompanyId,
                                auth_user_id: authUserId,
                                created_at: new Date().toISOString()
                            }]);

                        if (userError) {
                            console.error('Erro ao criar registro na tabela user:', userError);
                            throw new Error('Erro ao criar registro de usuário: ' + userError.message);
                        }

                        // 3. CRIAR REGISTRO NA TABELA FUNCIONARIOS (sem auth_user_id_funcionario)
                        const funcionarioDataFinal = { ...funcionarioData };
                        delete funcionarioDataFinal.senha_funcionario; // Remove senha dos dados

                        const { data: funcionarioCreated, error: funcionarioError } = await supabaseClient
                            .from('funcionarios')
                            .insert([funcionarioDataFinal])
                            .select();

                        if (funcionarioError) {
                            console.error('Erro ao criar funcionário:', funcionarioError);
                            throw new Error('Erro ao criar registro de funcionário: ' + funcionarioError.message);
                        }

                        console.log('Funcionário criado com sucesso:', funcionarioCreated[0]);
                        return funcionarioCreated[0];

                    } catch (dbError) {
                        // Se deu erro nos registros do banco, não tenta deletar auth (deixa para o usuário confirmar email)
                        console.error('Erro nos registros do banco:', dbError);
                        throw dbError;
                    }

                } catch (error) {
                    console.error('Erro no processo de criação do funcionário:', error);
                    throw error;
                }
            }

            async function updateFuncionario(id, funcionarioData) {
                // Remove campos que não devem ser atualizados
                delete funcionarioData.id_empresa;
                delete funcionarioData.auth_user_id;

                const { data, error } = await supabaseClient
                    .from('funcionarios')
                    .update(funcionarioData)
                    .eq('id', id)
                    .eq('id_empresa', window.currentCompanyId)
                    .select();

                if (error) throw error;

                return data[0];
            }

            async function loadFuncionarios() {
                try {
                    const { data, error } = await supabaseClient
                        .from('funcionarios')
                        .select('*')
                        .eq('id_empresa', window.currentCompanyId)
                        .eq('ativo', true)
                        .order('nome', { ascending: true });

                    if (error) throw error;

                    funcionarios = data || [];
                    renderFuncionarios();
                    updateCounter();
                    checkLimit();

                } catch (error) {
                    console.error('Erro ao carregar funcionários:', error);
                    showMessage('Erro ao carregar funcionários', true);
                }
            }

            function renderFuncionarios() {
                const container = document.getElementById('funcionarios-container');
                
                if (funcionarios.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>Nenhum funcionário cadastrado</h3>
                            <p>Clique na aba "Criar Funcionário" para começar</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="funcionarios-grid">
                        ${funcionarios.map(funcionario => `
                            <div class="funcionario-card">
                                <div class="funcionario-header">
                                    <div class="funcionario-info">
                                        <h3>${funcionario.nome}</h3>
                                        <div class="funcionario-codigo">${funcionario.codigo}</div>
                                    </div>
                                    <div class="funcionario-actions">
                                        <button class="btn-icon btn-edit" onclick="editFuncionario(${funcionario.id})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon btn-delete" onclick="deleteFuncionario(${funcionario.id})" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="funcionario-details">
                                    <div class="funcionario-detail">
                                        <strong>E-mail:</strong>
                                        <span>${funcionario.email}</span>
                                    </div>
                                    <div class="funcionario-detail">
                                        <strong>Telefone:</strong>
                                        <span>${funcionario.telefone}</span>
                                    </div>
                                    <div class="funcionario-detail">
                                        <strong>Admissão:</strong>
                                        <span>${formatDate(funcionario.data_admissao)}</span>
                                    </div>
                                    <div class="funcionario-detail">
                                        <strong>Meta de Vendas:</strong>
                                        <span>R$ ${formatCurrency(funcionario.meta_vendas)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            function updateCounter() {
                contadorFuncionarios.textContent = `${funcionarios.length}/10 funcionários`;
            }

            function checkLimit() {
                const isAtLimit = funcionarios.length >= 10;
                limitWarning.style.display = isAtLimit ? 'flex' : 'none';
                
                if (isAtLimit) {
                    limitWarning.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Você tem bastante funcionário, falei com desenvolvedor para criar mais!</span>
                    `;
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<i class="fas fa-ban"></i> Limite Atingido';
                } else if (!editingFuncionarioId) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Cadastrar Funcionário';
                }
            }

            function resetForm() {
                form.reset();
                generateEmployeeCode();
                document.getElementById('data_admissao').value = new Date().toISOString().split('T')[0];
                editingFuncionarioId = null;
                saveButton.innerHTML = '<i class="fas fa-save"></i> Cadastrar Funcionário';
                showMessage('', false);
                
                // Mostra campo de senha novamente
                const senhaField = document.getElementById('senha_funcionario').parentElement;
                senhaField.style.display = 'flex';
                
                // FORÇA LIMPEZA TOTAL DOS CAMPOS (impede cache)
                document.querySelectorAll('#funcionario-form input, #funcionario-form select, #funcionario-form textarea').forEach(field => {
                    field.value = '';
                    field.removeAttribute('data-value');
                    if (field.type === 'checkbox' || field.type === 'radio') {
                        field.checked = false;
                    }
                });
                
                // Redefine valores específicos após limpeza
                generateEmployeeCode();
                document.getElementById('data_admissao').value = new Date().toISOString().split('T')[0];
            }

            function showMessage(text, isError = false) {
                messageDiv.textContent = text;
                messageDiv.style.color = isError ? '#e74c3c' : '#27ae60';
                
                if (text) {
                    setTimeout(() => {
                        messageDiv.textContent = '';
                    }, 5000);
                }
            }

            // === FUNÇÕES AUXILIARES ===

            function formatDate(dateString) {
                if (!dateString) return 'Não informado';
                return new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR');
            }

            function formatCurrency(value) {
                if (!value) return '0,00';
                return parseFloat(value).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            function fillForm(funcionario) {
                document.getElementById('nome').value = funcionario.nome || '';
                document.getElementById('codigo').value = funcionario.codigo || '';
                document.getElementById('email').value = funcionario.email || '';
                document.getElementById('telefone').value = funcionario.telefone || '';
                document.getElementById('genero').value = funcionario.genero || '';
                document.getElementById('data_nascimento').value = funcionario.data_nascimento || '';
                document.getElementById('data_admissao').value = funcionario.data_admissao || '';
                document.getElementById('meta_vendas').value = funcionario.meta_vendas || '';
                document.getElementById('cep').value = funcionario.cep || '';
                document.getElementById('rua').value = funcionario.rua || '';
                document.getElementById('numero').value = funcionario.numero || '';
                document.getElementById('complemento').value = funcionario.complemento || '';
                document.getElementById('bairro').value = funcionario.bairro || '';
                document.getElementById('cidade').value = funcionario.cidade || '';
                
                // Esconde campo de senha na edição
                const senhaField = document.getElementById('senha_funcionario').parentElement;
                senhaField.style.display = 'none';
            }

            // === FUNÇÕES GLOBAIS (chamadas pelos botões) ===

            window.editFuncionario = async function(id) {
                try {
                    const funcionario = funcionarios.find(f => f.id === id);
                    if (!funcionario) {
                        showMessage('Funcionário não encontrado', true);
                        return;
                    }

                    editingFuncionarioId = id;
                    fillForm(funcionario);
                    
                    // Muda para aba de criação
                    document.querySelector('.tab-nav-item[data-tab="criar"]').click();
                    
                    // Atualiza o botão
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Atualizar Funcionário';
                    
                    showMessage('Editando funcionário. Faça as alterações e clique em Atualizar.', false);

                } catch (error) {
                    console.error('Erro ao editar funcionário:', error);
                    showMessage('Erro ao carregar dados do funcionário', true);
                }
            };

            window.deleteFuncionario = async function(id) {
                const funcionario = funcionarios.find(f => f.id === id);
                if (!funcionario) {
                    showMessage('Funcionário não encontrado', true);
                    return;
                }

                const confirmDelete = confirm(
                    `Tem certeza que deseja excluir o funcionário "${funcionario.nome}"?\n\n` +
                    'Esta ação não pode ser desfeita.'
                );

                if (!confirmDelete) return;

                try {
                    // Marca como inativo ao invés de deletar
                    const { error } = await supabaseClient
                        .from('funcionarios')
                        .update({ ativo: false })
                        .eq('id', id)
                        .eq('id_empresa', window.currentCompanyId);

                    if (error) throw error;

                    await loadFuncionarios();
                    showMessage('Funcionário excluído com sucesso!', false);

                } catch (error) {
                    console.error('Erro ao excluir funcionário:', error);
                    showMessage('Erro ao excluir funcionário', true);
                }
            };

            // === FORMATAÇÃO AUTOMÁTICA DE CAMPOS ===

            // Telefone
            document.getElementById('telefone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 11) {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (value.length >= 7) {
                    value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
                }
                e.target.value = value;
            });

            // CEP
            document.getElementById('cep').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 5) {
                    value = value.replace(/(\d{5})(\d{0,3})/, '$1-$2');
                }
                e.target.value = value.slice(0, 9);
            });

            // Meta de vendas
            document.getElementById('meta_vendas').addEventListener('input', function(e) {
                let value = parseFloat(e.target.value);
                if (value < 0) {
                    e.target.value = 0;
                }
            });

        });
    </script>
</body>
</html>