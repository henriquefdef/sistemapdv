<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume - Pagamento do Sistema</title>
    <link rel="icon" type="image/png" href="log.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="header.css" rel="stylesheet">
    
    <style>
        :root {
            --cor-laranja: #FF9800;
            --cor-laranja-hover: #FB8C00;
            --cor-fundo-pagina: #f4f7f6;
            --cor-fundo-card: #ffffff;
            --cor-texto-principal: #2c3e50;
            --cor-texto-secundario: #7f8c8d;
            --cor-borda: #e0e6ed;
            --sombra-card: 0 10px 40px -10px rgba(0, 64, 128, 0.1);
            --cor-verde: #27ae60;
            --cor-amarelo: #f39c12;
            --cor-vermelho: #e74c3c;
        }

        body {
            background-color: var(--cor-fundo-pagina);
            color: var(--cor-texto-principal);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding-left: 80px;
            transition: padding-left 0.3s ease;
        }

        .main-container {
            padding: 30px 40px;
            max-width: 1300px;
            margin: 0 auto;
        }

        /* Cards de status e planos */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .status-card {
            background: var(--cor-fundo-card);
            border-radius: 16px;
            box-shadow: var(--sombra-card);
            padding: 30px;
            text-align: center;
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .status-ativa { color: var(--cor-verde); }
        .status-vencendo { color: var(--cor-amarelo); }
        .status-vencida { color: var(--cor-vermelho); }

        .status-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-details {
            color: var(--cor-texto-secundario);
            margin-bottom: 20px;
        }

        .status-date {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
        }

        .date-ativa { background: rgba(39, 174, 96, 0.1); color: var(--cor-verde); }
        .date-vencendo { background: rgba(243, 156, 18, 0.1); color: var(--cor-amarelo); }
        .date-vencida { background: rgba(231, 76, 60, 0.1); color: var(--cor-vermelho); }

        /* Planos */
        .planos-section {
            background: var(--cor-fundo-card);
            border-radius: 16px;
            box-shadow: var(--sombra-card);
            overflow: hidden;
        }

        .planos-header {
            background: linear-gradient(135deg, var(--cor-laranja), var(--cor-laranja-hover));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .planos-header h2 {
            margin: 0 0 10px 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .planos-header p {
            margin: 0;
            opacity: 0.9;
        }

        .planos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .plano-card {
            padding: 40px 30px;
            text-align: center;
            border-right: 1px solid var(--cor-borda);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .plano-card:last-child {
            border-right: none;
        }

        .plano-card:hover {
            background: #f8f9fa;
            transform: translateY(-5px);
        }

        .plano-card.selected {
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid var(--cor-laranja);
        }

        .plano-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--cor-verde);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .plano-tipo {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--cor-laranja);
        }

        .plano-preco {
            font-size: 3rem;
            font-weight: 700;
            color: var(--cor-texto-principal);
            margin-bottom: 5px;
        }

        .plano-periodo {
            color: var(--cor-texto-secundario);
            margin-bottom: 20px;
        }

        .plano-beneficios {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        .plano-beneficios li {
            padding: 8px 0;
            color: var(--cor-texto-secundario);
        }

        .plano-beneficios li i {
            color: var(--cor-verde);
            margin-right: 10px;
        }

        /* Formas de pagamento */
        .pagamento-section {
            background: var(--cor-fundo-card);
            border-radius: 16px;
            box-shadow: var(--sombra-card);
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .pagamento-section.show {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .section-header i {
            font-size: 1.2rem;
            color: var(--cor-laranja);
        }

        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .pagamento-opcoes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .pagamento-card {
            border: 2px solid var(--cor-borda);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagamento-card:hover {
            border-color: var(--cor-laranja);
            transform: translateY(-2px);
        }

        .pagamento-card.selected {
            border-color: var(--cor-laranja);
            background: rgba(255, 152, 0, 0.1);
        }

        .pagamento-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .pix-icon { color: #32bcad; }
        .cartao-icon { color: #4caf50; }

        .pagamento-titulo {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .pagamento-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--cor-laranja);
            margin-bottom: 8px;
        }

        .pagamento-descricao {
            color: var(--cor-texto-secundario);
            font-size: 0.9rem;
        }

        .desconto-badge {
            background: var(--cor-verde);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* Bot√µes */
        .btn-pagar {
            background: linear-gradient(135deg, var(--cor-laranja), var(--cor-laranja-hover));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn-pagar:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px -5px rgba(255, 152, 0, 0.5);
        }

        .btn-pagar:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Hist√≥rico */
        .historico-section {
            background: var(--cor-fundo-card);
            border-radius: 16px;
            box-shadow: var(--sombra-card);
            padding: 30px;
            margin-top: 30px;
        }

        .historico-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--cor-borda);
        }

        .historico-item:last-child {
            border-bottom: none;
        }

        .historico-info {
            flex-grow: 1;
        }

        .historico-data {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .historico-detalhes {
            color: var(--cor-texto-secundario);
            font-size: 0.9rem;
        }

        .historico-valor {
            font-weight: 700;
            color: var(--cor-verde);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--cor-texto-secundario);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--cor-borda);
            margin-bottom: 20px;
            display: block;
        }

        /* Mensagens */
        #message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .message-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--cor-verde);
            border: 1px solid var(--cor-verde);
        }

        .message-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--cor-vermelho);
            border: 1px solid var(--cor-vermelho);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .cards-grid,
            .planos-grid,
            .pagamento-opcoes {
                grid-template-columns: 1fr;
            }

            .plano-card {
                border-right: none;
                border-bottom: 1px solid var(--cor-borda);
            }

            .plano-card:last-child {
                border-bottom: none;
            }

            .main-container {
                padding: 20px;
            }

            .plano-preco {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>

    <div id="header-container"></div>

    <main class="main-container">
        
        <!-- Status Atual -->
        <div class="cards-grid">
            <div class="status-card">
                <i id="status-icon" class="fas fa-clock status-icon status-vencendo"></i>
                <h2 id="status-title" class="status-title">Carregando...</h2>
                <p id="status-details" class="status-details">Verificando status da assinatura</p>
                <div id="status-date" class="status-date date-vencendo">--/--/----</div>
            </div>

            <div class="status-card">
                <i class="fas fa-chart-line status-icon" style="color: var(--cor-laranja);"></i>
                <h2 class="status-title">Benef√≠cios Ativos</h2>
                <div class="status-details">
                    <div style="margin-bottom: 10px;">‚úÖ Sistema completo</div>
                    <div style="margin-bottom: 10px;">‚úÖ Suporte t√©cnico</div>
                    <div style="margin-bottom: 10px;">‚úÖ Atualiza√ß√µes gratuitas</div>
                    <div>‚úÖ Backup autom√°tico</div>
                </div>
            </div>
        </div>

        <!-- Planos -->
        <div class="planos-section">
            <div class="planos-header">
                <h2><i class="fas fa-crown"></i> Escolha seu Plano</h2>
                <p>Mantenha seu sistema sempre ativo com os melhores pre√ßos</p>
            </div>
            
            <div class="planos-grid">
                <div class="plano-card" data-plano="mensal">
                    <div class="plano-tipo">Mensal</div>
                    <div class="plano-preco">R$ 27</div>
                    <div class="plano-periodo">por m√™s</div>
                    <ul class="plano-beneficios">
                        <li><i class="fas fa-check"></i> Todos os recursos</li>
                        <li><i class="fas fa-check"></i> Suporte t√©cnico</li>
                        <li><i class="fas fa-check"></i> Atualiza√ß√µes gratuitas</li>
                        <li><i class="fas fa-check"></i> Backup autom√°tico</li>
                    </ul>
                </div>

                <div class="plano-card" data-plano="anual">
                    <div class="plano-badge">Mais Popular</div>
                    <div class="plano-tipo">Anual</div>
                    <div class="plano-preco">R$ 276</div>
                    <div class="plano-periodo">por ano</div>
                    <ul class="plano-beneficios">
                        <li><i class="fas fa-check"></i> Todos os recursos</li>
                        <li><i class="fas fa-check"></i> Suporte priorit√°rio</li>
                        <li><i class="fas fa-check"></i> Atualiza√ß√µes gratuitas</li>
                        <li><i class="fas fa-check"></i> Backup autom√°tico</li>
                        <li><i class="fas fa-crown"></i> Desconto especial</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Formas de Pagamento -->
        <div id="pagamento-section" class="pagamento-section">
            <div class="section-header">
                <i class="fas fa-credit-card"></i>
                <h2>Forma de Pagamento</h2>
            </div>

            <div class="pagamento-opcoes">
                <div class="pagamento-card" data-pagamento="pix">
                    <i class="fas fa-qrcode pagamento-icon pix-icon"></i>
                    <div class="pagamento-titulo">PIX</div>
                    <div id="valor-pix" class="pagamento-valor">R$ 27,00</div>
                    <div class="pagamento-descricao">
                        Aprova√ß√£o instant√¢nea
                        <span class="desconto-badge">Sem taxas</span>
                    </div>
                </div>

                <div class="pagamento-card" data-pagamento="cartao">
                    <i class="fas fa-credit-card pagamento-icon cartao-icon"></i>
                    <div class="pagamento-titulo">Cart√£o de Cr√©dito</div>
                    <div id="valor-cartao" class="pagamento-valor">R$ 29,99</div>
                    <div class="pagamento-descricao">
                        Parcelamento dispon√≠vel<br>
                        <small>Taxas do Mercado Pago inclu√≠das</small>
                    </div>
                </div>
            </div>

            <div id="message"></div>

            <button id="btn-pagar" class="btn-pagar" disabled>
                <i class="fas fa-lock"></i> Selecione um plano e forma de pagamento
            </button>
        </div>

        <!-- Hist√≥rico -->
        <div class="historico-section">
            <div class="section-header">
                <i class="fas fa-history"></i>
                <h2>Hist√≥rico de Pagamentos</h2>
            </div>
            
            <div id="historico-container">
                <!-- Hist√≥rico ser√° carregado aqui -->
            </div>
        </div>

    </main>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="header.js"></script>

    <script>
        document.addEventListener('userDataReady', () => {
            if (!window.currentCompanyId) {
                console.error("ID da empresa n√£o encontrado.");
                return;
            }
            
            // Configura√ß√£o do Supabase
            const supabaseClient = supabase.createClient(
                'https://gnehkswoqlpchtlgyjyj.supabase.co', 
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZWhrc3dvcWxwY2h0bGd5anlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4OTY3NjYsImV4cCI6MjA2OTQ3Mjc2Nn0.8giA1bDvCzgvlcW_pkimGO9qHRF2I0QfhG6nx9U_tdY'
            );

            // Elementos da p√°gina
            const planoCards = document.querySelectorAll('.plano-card');
            const pagamentoCards = document.querySelectorAll('.pagamento-card');
            const pagamentoSection = document.getElementById('pagamento-section');
            const btnPagar = document.getElementById('btn-pagar');
            const messageDiv = document.getElementById('message');
            
            // Estado da sele√ß√£o
            let planoSelecionado = null;
            let pagamentoSelecionado = null;
            let assinaturaAtual = null;

            // Pre√ßos
            const precos = {
                mensal: { pix: 27.00, cartao: 29.99 },
                anual: { pix: 279.00, cartao: 309.99 }
            };

            // Configura√ß√£o inicial
            setupEventListeners();
            loadAssinaturaStatus();
            loadHistoricoPagamentos();

            // === FUN√á√ïES PRINCIPAIS ===

            function setupEventListeners() {
                // Sele√ß√£o de planos
                planoCards.forEach(card => {
                    card.addEventListener('click', () => {
                        planoCards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        planoSelecionado = card.dataset.plano;
                        updatePrecos();
                        pagamentoSection.classList.add('show');
                        updateButtonState();
                    });
                });

                // Sele√ß√£o de pagamento
                pagamentoCards.forEach(card => {
                    card.addEventListener('click', () => {
                        pagamentoCards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        pagamentoSelecionado = card.dataset.pagamento;
                        updateButtonState();
                    });
                });

                // Bot√£o pagar
                btnPagar.addEventListener('click', processarPagamento);
            }

            function updatePrecos() {
                if (!planoSelecionado) return;

                const valorPix = precos[planoSelecionado].pix;
                const valorCartao = precos[planoSelecionado].cartao;

                document.getElementById('valor-pix').textContent = `R$ ${valorPix.toFixed(2).replace('.', ',')}`;
                document.getElementById('valor-cartao').textContent = `R$ ${valorCartao.toFixed(2).replace('.', ',')}`;
            }

            function updateButtonState() {
                if (planoSelecionado && pagamentoSelecionado) {
                    const valor = precos[planoSelecionado][pagamentoSelecionado];
                    btnPagar.disabled = false;
                    btnPagar.innerHTML = `<i class="fas fa-credit-card"></i> Pagar R$ ${valor.toFixed(2).replace('.', ',')} - ${pagamentoSelecionado.toUpperCase()}`;
                } else {
                    btnPagar.disabled = true;
                    btnPagar.innerHTML = '<i class="fas fa-lock"></i> Selecione um plano e forma de pagamento';
                }
            }

            async function processarPagamento() {
                if (!planoSelecionado || !pagamentoSelecionado) return;

                const valor = precos[planoSelecionado][pagamentoSelecionado];
                
                // Loading state
                btnPagar.disabled = true;
                btnPagar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando pagamento...';

                try {
                    // SIMULA√á√ÉO - aqui integraria com Mercado Pago
                    await simularPagamento(valor);
                    
                    // Salva no Supabase
                    await salvarAssinatura(valor);
                    
                    showMessage('Pagamento realizado com sucesso! Sua assinatura foi renovada.', false);
                    
                    // Recarrega status
                    setTimeout(() => {
                        loadAssinaturaStatus();
                        loadHistoricoPagamentos();
                        resetSelecoes();
                    }, 2000);

                } catch (error) {
                    console.error('Erro no pagamento:', error);
                    showMessage('Erro ao processar pagamento. Tente novamente.', true);
                } finally {
                    btnPagar.disabled = false;
                    updateButtonState();
                }
            }

            async function simularPagamento(valor) {
                // Simula delay do pagamento
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        // 95% de sucesso na simula√ß√£o
                        if (Math.random() > 0.05) {
                            resolve({ status: 'approved', payment_id: 'SIM_' + Date.now() });
                        } else {
                            reject(new Error('Pagamento rejeitado'));
                        }
                    }, 2000);
                });
            }

            async function salvarAssinatura(valor) {
                const dataInicio = new Date();
                const dataVencimento = new Date();
                
                if (planoSelecionado === 'mensal') {
                    dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                } else {
                    dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
                }

                const assinaturaData = {
                    id_empresa: window.currentCompanyId,
                    auth_user_id: window.currentUser.auth_user_id,
                    plano: planoSelecionado,
                    valor_pago: valor,
                    data_inicio: dataInicio.toISOString().split('T')[0],
                    data_vencimento: dataVencimento.toISOString().split('T')[0],
                    status: 'ativa',
                    forma_pagamento: pagamentoSelecionado,
                    mercadopago_payment_id: 'SIM_' + Date.now()
                };

                // Verifica se j√° existe assinatura
                if (assinaturaAtual) {
                    // Atualiza existente
                    const { error } = await supabaseClient
                        .from('assinaturas')
                        .update(assinaturaData)
                        .eq('id_empresa', window.currentCompanyId);

                    if (error) throw error;
                } else {
                    // Cria nova
                    const { error } = await supabaseClient
                        .from('assinaturas')
                        .insert([assinaturaData]);

                    if (error) throw error;
                }
            }

            async function loadAssinaturaStatus() {
                try {
                    // 1. BUSCA DADOS DO empreendedor DA EMPRESA (para pegar data de cadastro)
                    const { data: empreendedorData, error: empreendedorError } = await supabaseClient
                        .from('user')
                        .select('created_at, nome')
                        .eq('id_empresa', window.currentCompanyId)
                        .eq('funcao', 'empreendedor')
                        .single();

                    if (empreendedorError) throw empreendedorError;

                    // 2. BUSCA ASSINATURA ATUAL
                    const { data: assinatura, error: assinaturaError } = await supabaseClient
                        .from('assinaturas')
                        .select('*')
                        .eq('id_empresa', window.currentCompanyId)
                        .single();

                    // Se n√£o tiver erro na assinatura, usa ela
                    if (!assinaturaError) {
                        assinaturaAtual = assinatura;
                        updateStatusDisplay(assinatura, empreendedorData);
                        return;
                    }

                    // 3. SE N√ÉO TEM ASSINATURA, VERIFICA PER√çODO DE TESTE
                    const dataCadastro = new Date(empreendedorData.created_at);
                    const hoje = new Date();
                    const diasTeste = 30;
                    const fimTeste = new Date(dataCadastro);
                    fimTeste.setDate(fimTeste.getDate() + diasTeste);

                    // Cria objeto simulado para per√≠odo de teste
                    const periodoTeste = {
                        plano: 'teste',
                        data_inicio: dataCadastro.toISOString().split('T')[0],
                        data_vencimento: fimTeste.toISOString().split('T')[0],
                        status: hoje <= fimTeste ? 'teste_ativo' : 'teste_vencido',
                        valor_pago: 0,
                        forma_pagamento: 'gratuito',
                        empreendedor_nome: empreendedorData.nome
                    };

                    assinaturaAtual = periodoTeste;
                    updateStatusDisplay(periodoTeste, empreendedorData);

                } catch (error) {
                    console.error('Erro ao carregar status:', error);
                    updateStatusDisplay(null, null);
                }
            }

            function updateStatusDisplay(assinatura, empreendedorData) {
                const statusIcon = document.getElementById('status-icon');
                const statusTitle = document.getElementById('status-title');
                const statusDetails = document.getElementById('status-details');
                const statusDate = document.getElementById('status-date');

                if (!assinatura) {
                    // Erro - n√£o conseguiu carregar
                    statusIcon.className = 'fas fa-exclamation-triangle status-icon status-vencida';
                    statusTitle.textContent = 'Erro ao carregar';
                    statusDetails.textContent = 'N√£o foi poss√≠vel verificar o status da assinatura';
                    statusDate.textContent = 'Recarregue a p√°gina';
                    statusDate.className = 'status-date date-vencida';
                    return;
                }

                const hoje = new Date();
                const vencimento = new Date(assinatura.data_vencimento + 'T00:00:00');
                const diasRestantes = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));

                // PER√çODO DE TESTE
                if (assinatura.plano === 'teste') {
                    if (assinatura.status === 'teste_ativo') {
                        statusIcon.className = 'fas fa-gift status-icon status-ativa';
                        statusTitle.textContent = 'Per√≠odo de Teste Gratuito';
                        statusDetails.textContent = `Empresa cadastrada por ${assinatura.empreendedor_nome} - ${diasRestantes} dias restantes`;
                        statusDate.textContent = `V√°lido at√© ${formatDate(assinatura.data_vencimento)}`;
                        statusDate.className = 'status-date date-ativa';
                    } else {
                        statusIcon.className = 'fas fa-hourglass-end status-icon status-vencida';
                        statusTitle.textContent = 'Per√≠odo de Teste Expirado';
                        statusDetails.textContent = `Teste gratuito venceu h√° ${Math.abs(diasRestantes)} dias`;
                        statusDate.textContent = 'Assine um plano para continuar';
                        statusDate.className = 'status-date date-vencida';
                    }
                    return;
                }

                // ASSINATURA PAGA
                if (diasRestantes > 7) {
                    // Ativa
                    statusIcon.className = 'fas fa-check-circle status-icon status-ativa';
                    statusTitle.textContent = 'Assinatura Ativa';
                    statusDetails.textContent = `Plano ${assinatura.plano} - ${diasRestantes} dias restantes`;
                    statusDate.textContent = `Renova√ß√£o em ${formatDate(assinatura.data_vencimento)}`;
                    statusDate.className = 'status-date date-ativa';
                } else if (diasRestantes > 0) {
                    // Vencendo
                    statusIcon.className = 'fas fa-clock status-icon status-vencendo';
                    statusTitle.textContent = 'Assinatura Vencendo';
                    statusDetails.textContent = `Renove sua assinatura - ${diasRestantes} dias restantes`;
                    statusDate.textContent = `Vence em ${formatDate(assinatura.data_vencimento)}`;
                    statusDate.className = 'status-date date-vencendo';
                } else {
                    // Vencida
                    statusIcon.className = 'fas fa-times-circle status-icon status-vencida';
                    statusTitle.textContent = 'Assinatura Vencida';
                    statusDetails.textContent = `Venceu h√° ${Math.abs(diasRestantes)} dias - Acesso limitado`;
                    statusDate.textContent = `Venceu em ${formatDate(assinatura.data_vencimento)}`;
                    statusDate.className = 'status-date date-vencida';
                }
            }

            async function loadHistoricoPagamentos() {
                try {
                    const { data, error } = await supabaseClient
                        .from('assinaturas')
                        .select('*')
                        .eq('id_empresa', window.currentCompanyId)
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (error) throw error;

                    renderHistorico(data || []);

                } catch (error) {
                    console.error('Erro ao carregar hist√≥rico:', error);
                    renderHistorico([]);
                }
            }

            function renderHistorico(historico) {
                const container = document.getElementById('historico-container');
                
                if (historico.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <h3>Nenhum pagamento encontrado</h3>
                            <p>Seus pagamentos aparecer√£o aqui</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = historico.map(item => `
                    <div class="historico-item">
                        <div class="historico-info">
                            <div class="historico-data">${formatDate(item.data_inicio)}</div>
                            <div class="historico-detalhes">
                                Plano ${item.plano} - ${item.forma_pagamento.toUpperCase()} 
                                ${item.status === 'ativa' ? '‚úÖ' : item.status === 'vencida' ? '‚è∞' : 'üîÑ'}
                            </div>
                        </div>
                        <div class="historico-valor">R$ ${item.valor_pago.toFixed(2).replace('.', ',')}</div>
                    </div>
                `).join('');
            }

            function resetSelecoes() {
                planoCards.forEach(c => c.classList.remove('selected'));
                pagamentoCards.forEach(c => c.classList.remove('selected'));
                pagamentoSection.classList.remove('show');
                planoSelecionado = null;
                pagamentoSelecionado = null;
                updateButtonState();
                hideMessage();
            }

            function showMessage(text, isError = false) {
                messageDiv.textContent = text;
                messageDiv.className = isError ? 'message-error' : 'message-success';
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    hideMessage();
                }, 5000);
            }

            function hideMessage() {
                messageDiv.style.display = 'none';
            }

            function formatDate(dateString) {
                if (!dateString) return 'Data inv√°lida';
                const date = new Date(dateString + 'T00:00:00');
                return date.toLocaleDateString('pt-BR');
            }

        });
    </script>
</body>
</html>